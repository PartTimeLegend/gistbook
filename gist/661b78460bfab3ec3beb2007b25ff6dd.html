<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MissingIndexes.sql</title>
    <!-- Begin Jekyll SEO tag v2.8.0 -->
    <meta name="generator" content="Jekyll v4.2.2" />
    <meta property="og:title" content="MissingIndexes.sql" />
    <meta name="author" content="Tom치코 Krupka" />
    <meta property="og:locale" content="en_US" />
    <meta
      name="description"
      content='print &#39;-- query and plan hash capture --&#39; print &#39;-- query and plan hash capture --&#39; print &#39;-- top 10 CPU by query_hash --&#39; select getdate() as runtime, * --into tbl_QueryHashByCPU from ( SELECT TOP 10 query_hash, COUNT (distinct query_plan_hash) as &#39;distinctquery_plan_hash count&#39;, sum(execution_count) as &#39;execution_count&#39;, sum(total_worker_time) as &#39;total_worker_time&#39;, SUM(total_elapsed_time) as &#39;total_elapsed_time&#39;, SUM (total_logical_reads) as &#39;total_logical_reads&#39;, max(REPLACE (REPLACE (SUBSTRING (st.[text], qs.statement_start_offset/2 + 1, CASE WHEN qs.statement_end_offset = -1 THEN LEN (CONVERT(nvarchar(max), st.[text])) ELSE qs.statement_end_offset/2 - qs.statement_start_offset/2 + 1 END), CHAR(13), &#39; &#39;), CHAR(10), &#39; &#39;)) AS sample_statement_text FROM sys.dm_exec_query_stats AS qs CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS st group by query_hash ORDER BY sum(total_worker_time) DESC ) t go --Find out which one is on the TOP and then run the below query to find the missing indexes: DECLARE @runtime datetime DECLARE @cpu_time_start bigint, @cpu_time bigint, @elapsed_time_start bigint, @rowcount bigint DECLARE @queryduration int, @qrydurationwarnthreshold int DECLARE @querystarttime datetime SET @runtime = GETDATE() SET @qrydurationwarnthreshold = 5000 PRINT &#39;&#39; PRINT &#39;===============================================================================================&#39; PRINT &#39;Missing Indexes: &#39; PRINT &#39;The "improvement_measure" column is an indicator of the (estimated) improvement that might &#39; PRINT &#39;be seen if the index was created. This is a unitless number, and has meaning only relative &#39; PRINT &#39;the same number for other indexes. The measure is a combination of the avg_total_user_cost, &#39; PRINT &#39;avg_user_impact, user_seeks, and user_scans columns in sys.dm_db_missing_index_group_stats.&#39; PRINT &#39;&#39; PRINT &#39;-- Missing Indexes --&#39; SELECT CONVERT (varchar, @runtime, 126) AS runtime, mig.index_group_handle, mid.index_handle, CONVERT (decimal (28,1), migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans)) AS improvement_measure, &#39;CREATE INDEX missing_index_&#39; + CONVERT (varchar, mig.index_group_handle) + &#39;_&#39; + CONVERT (varchar, mid.index_handle) + &#39; ON &#39; + mid.statement + &#39; (&#39; + ISNULL (mid.equality_columns,&#39;&#39;) + CASE WHEN mid.equality_columns IS NOT NULL AND mid.inequality_columns IS NOT NULL THEN &#39;,&#39; ELSE &#39;&#39; END + ISNULL (mid.inequality_columns, &#39;&#39;) + &#39;)&#39; + ISNULL (&#39; INCLUDE (&#39; + mid.included_columns + &#39;)&#39;, &#39;&#39;) AS create_index_statement, migs.*, mid.database_id, mid.[object_id] FROM sys.dm_db_missing_index_groups mig INNER JOIN sys.dm_db_missing_index_group_stats migs ON migs.group_handle = mig.index_group_handle INNER JOIN sys.dm_db_missing_index_details mid ON mig.index_handle = mid.index_handle WHERE CONVERT (decimal (28,1), migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans)) &gt; 10 ORDER BY migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans) DESC PRINT &#39;&#39; GO'
    />
    <meta
      property="og:description"
      content='print &#39;-- query and plan hash capture --&#39; print &#39;-- query and plan hash capture --&#39; print &#39;-- top 10 CPU by query_hash --&#39; select getdate() as runtime, * --into tbl_QueryHashByCPU from ( SELECT TOP 10 query_hash, COUNT (distinct query_plan_hash) as &#39;distinctquery_plan_hash count&#39;, sum(execution_count) as &#39;execution_count&#39;, sum(total_worker_time) as &#39;total_worker_time&#39;, SUM(total_elapsed_time) as &#39;total_elapsed_time&#39;, SUM (total_logical_reads) as &#39;total_logical_reads&#39;, max(REPLACE (REPLACE (SUBSTRING (st.[text], qs.statement_start_offset/2 + 1, CASE WHEN qs.statement_end_offset = -1 THEN LEN (CONVERT(nvarchar(max), st.[text])) ELSE qs.statement_end_offset/2 - qs.statement_start_offset/2 + 1 END), CHAR(13), &#39; &#39;), CHAR(10), &#39; &#39;)) AS sample_statement_text FROM sys.dm_exec_query_stats AS qs CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS st group by query_hash ORDER BY sum(total_worker_time) DESC ) t go --Find out which one is on the TOP and then run the below query to find the missing indexes: DECLARE @runtime datetime DECLARE @cpu_time_start bigint, @cpu_time bigint, @elapsed_time_start bigint, @rowcount bigint DECLARE @queryduration int, @qrydurationwarnthreshold int DECLARE @querystarttime datetime SET @runtime = GETDATE() SET @qrydurationwarnthreshold = 5000 PRINT &#39;&#39; PRINT &#39;===============================================================================================&#39; PRINT &#39;Missing Indexes: &#39; PRINT &#39;The "improvement_measure" column is an indicator of the (estimated) improvement that might &#39; PRINT &#39;be seen if the index was created. This is a unitless number, and has meaning only relative &#39; PRINT &#39;the same number for other indexes. The measure is a combination of the avg_total_user_cost, &#39; PRINT &#39;avg_user_impact, user_seeks, and user_scans columns in sys.dm_db_missing_index_group_stats.&#39; PRINT &#39;&#39; PRINT &#39;-- Missing Indexes --&#39; SELECT CONVERT (varchar, @runtime, 126) AS runtime, mig.index_group_handle, mid.index_handle, CONVERT (decimal (28,1), migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans)) AS improvement_measure, &#39;CREATE INDEX missing_index_&#39; + CONVERT (varchar, mig.index_group_handle) + &#39;_&#39; + CONVERT (varchar, mid.index_handle) + &#39; ON &#39; + mid.statement + &#39; (&#39; + ISNULL (mid.equality_columns,&#39;&#39;) + CASE WHEN mid.equality_columns IS NOT NULL AND mid.inequality_columns IS NOT NULL THEN &#39;,&#39; ELSE &#39;&#39; END + ISNULL (mid.inequality_columns, &#39;&#39;) + &#39;)&#39; + ISNULL (&#39; INCLUDE (&#39; + mid.included_columns + &#39;)&#39;, &#39;&#39;) AS create_index_statement, migs.*, mid.database_id, mid.[object_id] FROM sys.dm_db_missing_index_groups mig INNER JOIN sys.dm_db_missing_index_group_stats migs ON migs.group_handle = mig.index_group_handle INNER JOIN sys.dm_db_missing_index_details mid ON mig.index_handle = mid.index_handle WHERE CONVERT (decimal (28,1), migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans)) &gt; 10 ORDER BY migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans) DESC PRINT &#39;&#39; GO'
    />
    <link
      rel="canonical"
      href="https://parttimelegend.github.io/gistbook/gist/661b78460bfab3ec3beb2007b25ff6dd"
    />
    <meta
      property="og:url"
      content="https://parttimelegend.github.io/gistbook/gist/661b78460bfab3ec3beb2007b25ff6dd"
    />
    <meta property="og:site_name" content="Gistbook" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2016-10-14T05:46:56+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="MissingIndexes.sql" />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": { "@type": "Person", "name": "Tom치코 Krupka" },
        "dateModified": "2016-10-14T05:46:56+00:00",
        "datePublished": "2016-10-14T05:46:56+00:00",
        "description": "print &#39;-- query and plan hash capture --&#39; print &#39;-- query and plan hash capture --&#39; print &#39;-- top 10 CPU by query_hash --&#39; select getdate() as runtime, * --into tbl_QueryHashByCPU from ( SELECT TOP 10 query_hash, COUNT (distinct query_plan_hash) as &#39;distinctquery_plan_hash count&#39;, sum(execution_count) as &#39;execution_count&#39;, sum(total_worker_time) as &#39;total_worker_time&#39;, SUM(total_elapsed_time) as &#39;total_elapsed_time&#39;, SUM (total_logical_reads) as &#39;total_logical_reads&#39;, max(REPLACE (REPLACE (SUBSTRING (st.[text], qs.statement_start_offset/2 + 1, CASE WHEN qs.statement_end_offset = -1 THEN LEN (CONVERT(nvarchar(max), st.[text])) ELSE qs.statement_end_offset/2 - qs.statement_start_offset/2 + 1 END), CHAR(13), &#39; &#39;), CHAR(10), &#39; &#39;)) AS sample_statement_text FROM sys.dm_exec_query_stats AS qs CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS st group by query_hash ORDER BY sum(total_worker_time) DESC ) t go --Find out which one is on the TOP and then run the below query to find the missing indexes: DECLARE @runtime datetime DECLARE @cpu_time_start bigint, @cpu_time bigint, @elapsed_time_start bigint, @rowcount bigint DECLARE @queryduration int, @qrydurationwarnthreshold int DECLARE @querystarttime datetime SET @runtime = GETDATE() SET @qrydurationwarnthreshold = 5000 PRINT &#39;&#39; PRINT &#39;===============================================================================================&#39; PRINT &#39;Missing Indexes: &#39; PRINT &#39;The &quot;improvement_measure&quot; column is an indicator of the (estimated) improvement that might &#39; PRINT &#39;be seen if the index was created. This is a unitless number, and has meaning only relative &#39; PRINT &#39;the same number for other indexes. The measure is a combination of the avg_total_user_cost, &#39; PRINT &#39;avg_user_impact, user_seeks, and user_scans columns in sys.dm_db_missing_index_group_stats.&#39; PRINT &#39;&#39; PRINT &#39;-- Missing Indexes --&#39; SELECT CONVERT (varchar, @runtime, 126) AS runtime, mig.index_group_handle, mid.index_handle, CONVERT (decimal (28,1), migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans)) AS improvement_measure, &#39;CREATE INDEX missing_index_&#39; + CONVERT (varchar, mig.index_group_handle) + &#39;_&#39; + CONVERT (varchar, mid.index_handle) + &#39; ON &#39; + mid.statement + &#39; (&#39; + ISNULL (mid.equality_columns,&#39;&#39;) + CASE WHEN mid.equality_columns IS NOT NULL AND mid.inequality_columns IS NOT NULL THEN &#39;,&#39; ELSE &#39;&#39; END + ISNULL (mid.inequality_columns, &#39;&#39;) + &#39;)&#39; + ISNULL (&#39; INCLUDE (&#39; + mid.included_columns + &#39;)&#39;, &#39;&#39;) AS create_index_statement, migs.*, mid.database_id, mid.[object_id] FROM sys.dm_db_missing_index_groups mig INNER JOIN sys.dm_db_missing_index_group_stats migs ON migs.group_handle = mig.index_group_handle INNER JOIN sys.dm_db_missing_index_details mid ON mig.index_handle = mid.index_handle WHERE CONVERT (decimal (28,1), migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans)) &gt; 10 ORDER BY migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans) DESC PRINT &#39;&#39; GO",
        "headline": "MissingIndexes.sql",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://parttimelegend.github.io/gistbook/gist/661b78460bfab3ec3beb2007b25ff6dd"
        },
        "url": "https://parttimelegend.github.io/gistbook/gist/661b78460bfab3ec3beb2007b25ff6dd"
      }
    </script>
    <!-- End Jekyll SEO tag -->
    <link
      type="application/atom+xml"
      rel="alternate"
      href="https://parttimelegend.github.io/gistbook/feed.xml"
      title="Gistbook"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/gistbook/logo.png" />
    <link rel="stylesheet" href="/gistbook/assets/css/main.css" />
  </head>
  <body a="auto">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/gistbook/">home</a>
        <article>
          <p class="post-meta">
            <time datetime="2016-10-14 05:46:56 +0000">2016-10-14</time>
          </p>

          <h1>MissingIndexes.sql</h1>
          <noscript>
            <pre>
print &#39;-- query and plan hash capture --&#39;

print &#39;-- query and plan hash capture --&#39;

print &#39;-- top 10 CPU by query_hash --&#39;

select getdate() as runtime, *  --into tbl_QueryHashByCPU

from

(

SELECT TOP 10 query_hash, COUNT (distinct query_plan_hash) as &#39;distinctquery_plan_hash count&#39;,

sum(execution_count) as &#39;execution_count&#39;,

       sum(total_worker_time) as &#39;total_worker_time&#39;,

       SUM(total_elapsed_time) as &#39;total_elapsed_time&#39;,

       SUM (total_logical_reads) as &#39;total_logical_reads&#39;,

       

    max(REPLACE (REPLACE (SUBSTRING (st.[text], qs.statement_start_offset/2 + 1,

      CASE WHEN qs.statement_end_offset = -1 THEN LEN (CONVERT(nvarchar(max), st.[text]))

        ELSE qs.statement_end_offset/2 - qs.statement_start_offset/2 + 1

      END), CHAR(13), &#39; &#39;), CHAR(10), &#39; &#39;))  AS sample_statement_text

FROM sys.dm_exec_query_stats AS qs

CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) AS st

group by query_hash

ORDER BY sum(total_worker_time) DESC

) t

go

--Find out which one is on the TOP and then run the below query to find the missing indexes:

DECLARE @runtime datetime

DECLARE @cpu_time_start bigint, @cpu_time bigint, @elapsed_time_start bigint, @rowcount bigint

DECLARE @queryduration int, @qrydurationwarnthreshold int

DECLARE @querystarttime datetime

SET @runtime = GETDATE()

SET @qrydurationwarnthreshold = 5000

PRINT &#39;&#39;

PRINT &#39;===============================================================================================&#39;

PRINT &#39;Missing Indexes: &#39;

PRINT &#39;The &quot;improvement_measure&quot; column is an indicator of the (estimated) improvement that might &#39;

PRINT &#39;be seen if the index was created. This is a unitless number, and has meaning only relative &#39;

PRINT &#39;the same number for other indexes. The measure is a combination of the avg_total_user_cost, &#39;

PRINT &#39;avg_user_impact, user_seeks, and user_scans columns in sys.dm_db_missing_index_group_stats.&#39;

PRINT &#39;&#39;

PRINT &#39;-- Missing Indexes --&#39;

SELECT CONVERT (varchar, @runtime, 126) AS runtime,

mig.index_group_handle, mid.index_handle,

CONVERT (decimal (28,1), migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans)) AS improvement_measure,

&#39;CREATE INDEX missing_index_&#39; + CONVERT (varchar, mig.index_group_handle) + &#39;_&#39; + CONVERT (varchar, mid.index_handle)

+ &#39; ON &#39; + mid.statement

+ &#39; (&#39; + ISNULL (mid.equality_columns,&#39;&#39;)

+ CASE WHEN mid.equality_columns IS NOT NULL AND mid.inequality_columns IS NOT NULL THEN &#39;,&#39; ELSE &#39;&#39; END + ISNULL (mid.inequality_columns, &#39;&#39;)

+ &#39;)&#39;

+ ISNULL (&#39; INCLUDE (&#39; + mid.included_columns + &#39;)&#39;, &#39;&#39;) AS create_index_statement,

migs.*, mid.database_id, mid.[object_id]

FROM sys.dm_db_missing_index_groups mig

INNER JOIN sys.dm_db_missing_index_group_stats migs ON migs.group_handle = mig.index_group_handle

INNER JOIN sys.dm_db_missing_index_details mid ON mig.index_handle = mid.index_handle

WHERE CONVERT (decimal (28,1), migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans)) &gt; 10

ORDER BY migs.avg_total_user_cost * migs.avg_user_impact * (migs.user_seeks + migs.user_scans) DESC

PRINT &#39;&#39;

GO
</pre
            >
          </noscript>
          <script src="https://gist.github.com/PartTimeLegend/661b78460bfab3ec3beb2007b25ff6dd.js"></script>
        </article>
      </div>
    </main>
  </body>
</html>
