<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>encrypt-ami.sh</title>
    <!-- Begin Jekyll SEO tag v2.8.0 -->
    <meta name="generator" content="Jekyll v4.2.2" />
    <meta property="og:title" content="encrypt-ami.sh" />
    <meta name="author" content="Tom치코 Krupka" />
    <meta property="og:locale" content="en_US" />
    <meta
      name="description"
      content='#!/usr/bin/env bash set -e REGION=$1 PROFILE=$2 SOURCE_AMI=$3 NAME=$4 # Run Instance from Base AMI echo "Creating instance from AMI $SOURCE_AMI" INSTANCE=`aws ec2 run-instances --image-id $SOURCE_AMI --count 1 --instance-type t2.micro --query &#39;Instances[0].InstanceId&#39; --profile $PROFILE` INSTANCE=`sed -e &#39;s/^"//&#39; -e &#39;s/"$//&#39; &lt;&lt;&lt;"$INSTANCE"` echo "Waiting for instance $INSTANCE to be running and status OK..." aws ec2 wait instance-status-ok --instance-ids $INSTANCE --profile $PROFILE echo "Creating account AMI copy" AMI_COPY=`aws ec2 create-image --instance-id $INSTANCE --block-device-mappings DeviceName=/dev/sda1,Ebs={DeleteOnTermination=True} --name "SOURCE_AMI Copy for $NAME" --query &#39;ImageId&#39; --profile $PROFILE` AMI_COPY=`sed -e &#39;s/^"//&#39; -e &#39;s/"$//&#39; &lt;&lt;&lt;"$AMI_COPY"` echo "Waiting for AMI COPY $AMI_COPY to be available..." aws ec2 wait image-available --image-ids $AMI_COPY --profile $PROFILE echo "Terminating unencrypted instance..." TERMINATION=`aws ec2 terminate-instances --instance-ids $INSTANCE --profile $PROFILE` echo "Creating Encrypted AMI" AMI_ENC=`aws ec2 copy-image --source-image-id $AMI_COPY --name "$NAME Encrypted" --encrypted --source-region $REGION --region $REGION --query &#39;ImageId&#39; --profile $PROFILE` AMI_ENC=`sed -e &#39;s/^"//&#39; -e &#39;s/"$//&#39; &lt;&lt;&lt;"$AMI_ENC"` echo "Waiting for Encrypted AMI $AMI_ENC to be available..." aws ec2 wait image-available --image-ids $AMI_ENC --profile $PROFILE echo "Deleting unneeded AMI Copy" REMOVED=`aws ec2 deregister-image --image-id $AMI_COPY --profile $PROFILE` aws ec2 wait instance-terminated --instance-ids $INSTANCE --profile $PROFILE echo "Everything is good! Your new AMI &#39;$NAME Encrypted&#39; is available as $AMI_ENC"'
    />
    <meta
      property="og:description"
      content='#!/usr/bin/env bash set -e REGION=$1 PROFILE=$2 SOURCE_AMI=$3 NAME=$4 # Run Instance from Base AMI echo "Creating instance from AMI $SOURCE_AMI" INSTANCE=`aws ec2 run-instances --image-id $SOURCE_AMI --count 1 --instance-type t2.micro --query &#39;Instances[0].InstanceId&#39; --profile $PROFILE` INSTANCE=`sed -e &#39;s/^"//&#39; -e &#39;s/"$//&#39; &lt;&lt;&lt;"$INSTANCE"` echo "Waiting for instance $INSTANCE to be running and status OK..." aws ec2 wait instance-status-ok --instance-ids $INSTANCE --profile $PROFILE echo "Creating account AMI copy" AMI_COPY=`aws ec2 create-image --instance-id $INSTANCE --block-device-mappings DeviceName=/dev/sda1,Ebs={DeleteOnTermination=True} --name "SOURCE_AMI Copy for $NAME" --query &#39;ImageId&#39; --profile $PROFILE` AMI_COPY=`sed -e &#39;s/^"//&#39; -e &#39;s/"$//&#39; &lt;&lt;&lt;"$AMI_COPY"` echo "Waiting for AMI COPY $AMI_COPY to be available..." aws ec2 wait image-available --image-ids $AMI_COPY --profile $PROFILE echo "Terminating unencrypted instance..." TERMINATION=`aws ec2 terminate-instances --instance-ids $INSTANCE --profile $PROFILE` echo "Creating Encrypted AMI" AMI_ENC=`aws ec2 copy-image --source-image-id $AMI_COPY --name "$NAME Encrypted" --encrypted --source-region $REGION --region $REGION --query &#39;ImageId&#39; --profile $PROFILE` AMI_ENC=`sed -e &#39;s/^"//&#39; -e &#39;s/"$//&#39; &lt;&lt;&lt;"$AMI_ENC"` echo "Waiting for Encrypted AMI $AMI_ENC to be available..." aws ec2 wait image-available --image-ids $AMI_ENC --profile $PROFILE echo "Deleting unneeded AMI Copy" REMOVED=`aws ec2 deregister-image --image-id $AMI_COPY --profile $PROFILE` aws ec2 wait instance-terminated --instance-ids $INSTANCE --profile $PROFILE echo "Everything is good! Your new AMI &#39;$NAME Encrypted&#39; is available as $AMI_ENC"'
    />
    <link
      rel="canonical"
      href="https://parttimelegend.github.io/gistbook/gist/afeb172468753143bf9846968af3afed"
    />
    <meta
      property="og:url"
      content="https://parttimelegend.github.io/gistbook/gist/afeb172468753143bf9846968af3afed"
    />
    <meta property="og:site_name" content="Gistbook" />
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content="2020-11-11T16:08:55+00:00"
    />
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="encrypt-ami.sh" />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": { "@type": "Person", "name": "Tom치코 Krupka" },
        "dateModified": "2020-11-11T16:08:55+00:00",
        "datePublished": "2020-11-11T16:08:55+00:00",
        "description": "#!/usr/bin/env bash set -e REGION=$1 PROFILE=$2 SOURCE_AMI=$3 NAME=$4 # Run Instance from Base AMI echo &quot;Creating instance from AMI $SOURCE_AMI&quot; INSTANCE=`aws ec2 run-instances --image-id $SOURCE_AMI --count 1 --instance-type t2.micro --query &#39;Instances[0].InstanceId&#39; --profile $PROFILE` INSTANCE=`sed -e &#39;s/^&quot;//&#39; -e &#39;s/&quot;$//&#39; &lt;&lt;&lt;&quot;$INSTANCE&quot;` echo &quot;Waiting for instance $INSTANCE to be running and status OK...&quot; aws ec2 wait instance-status-ok --instance-ids $INSTANCE --profile $PROFILE echo &quot;Creating account AMI copy&quot; AMI_COPY=`aws ec2 create-image --instance-id $INSTANCE --block-device-mappings DeviceName=/dev/sda1,Ebs={DeleteOnTermination=True} --name &quot;SOURCE_AMI Copy for $NAME&quot; --query &#39;ImageId&#39; --profile $PROFILE` AMI_COPY=`sed -e &#39;s/^&quot;//&#39; -e &#39;s/&quot;$//&#39; &lt;&lt;&lt;&quot;$AMI_COPY&quot;` echo &quot;Waiting for AMI COPY $AMI_COPY to be available...&quot; aws ec2 wait image-available --image-ids $AMI_COPY --profile $PROFILE echo &quot;Terminating unencrypted instance...&quot; TERMINATION=`aws ec2 terminate-instances --instance-ids $INSTANCE --profile $PROFILE` echo &quot;Creating Encrypted AMI&quot; AMI_ENC=`aws ec2 copy-image --source-image-id $AMI_COPY --name &quot;$NAME Encrypted&quot; --encrypted --source-region $REGION --region $REGION --query &#39;ImageId&#39; --profile $PROFILE` AMI_ENC=`sed -e &#39;s/^&quot;//&#39; -e &#39;s/&quot;$//&#39; &lt;&lt;&lt;&quot;$AMI_ENC&quot;` echo &quot;Waiting for Encrypted AMI $AMI_ENC to be available...&quot; aws ec2 wait image-available --image-ids $AMI_ENC --profile $PROFILE echo &quot;Deleting unneeded AMI Copy&quot; REMOVED=`aws ec2 deregister-image --image-id $AMI_COPY --profile $PROFILE` aws ec2 wait instance-terminated --instance-ids $INSTANCE --profile $PROFILE echo &quot;Everything is good! Your new AMI &#39;$NAME Encrypted&#39; is available as $AMI_ENC&quot;",
        "headline": "encrypt-ami.sh",
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "https://parttimelegend.github.io/gistbook/gist/afeb172468753143bf9846968af3afed"
        },
        "url": "https://parttimelegend.github.io/gistbook/gist/afeb172468753143bf9846968af3afed"
      }
    </script>
    <!-- End Jekyll SEO tag -->
    <link
      type="application/atom+xml"
      rel="alternate"
      href="https://parttimelegend.github.io/gistbook/feed.xml"
      title="Gistbook"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/gistbook/logo.png" />
    <link rel="stylesheet" href="/gistbook/assets/css/main.css" />
  </head>
  <body a="auto">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/gistbook/">home</a>
        <article>
          <p class="post-meta">
            <time datetime="2020-11-11 16:08:55 +0000">2020-11-11</time>
          </p>

          <h1>encrypt-ami.sh</h1>
          <noscript>
            <pre>
#!/usr/bin/env bash
set -e

REGION=$1
PROFILE=$2
SOURCE_AMI=$3
NAME=$4

# Run Instance from Base AMI
echo &quot;Creating instance from AMI $SOURCE_AMI&quot;
INSTANCE=`aws ec2 run-instances --image-id $SOURCE_AMI --count 1 --instance-type t2.micro --query &#39;Instances[0].InstanceId&#39; --profile $PROFILE`
INSTANCE=`sed -e &#39;s/^&quot;//&#39; -e &#39;s/&quot;$//&#39; &lt;&lt;&lt;&quot;$INSTANCE&quot;`

echo &quot;Waiting for instance $INSTANCE to be running and status OK...&quot;
aws ec2 wait instance-status-ok --instance-ids $INSTANCE --profile $PROFILE

echo &quot;Creating account AMI copy&quot;
AMI_COPY=`aws ec2 create-image --instance-id $INSTANCE --block-device-mappings DeviceName=/dev/sda1,Ebs={DeleteOnTermination=True} --name &quot;SOURCE_AMI Copy for $NAME&quot; --query &#39;ImageId&#39; --profile $PROFILE`
AMI_COPY=`sed -e &#39;s/^&quot;//&#39; -e &#39;s/&quot;$//&#39; &lt;&lt;&lt;&quot;$AMI_COPY&quot;`

echo &quot;Waiting for AMI COPY $AMI_COPY to be available...&quot;
aws ec2 wait image-available --image-ids $AMI_COPY --profile $PROFILE

echo &quot;Terminating unencrypted instance...&quot;
TERMINATION=`aws ec2 terminate-instances --instance-ids $INSTANCE --profile $PROFILE`

echo &quot;Creating Encrypted AMI&quot;
AMI_ENC=`aws ec2 copy-image --source-image-id $AMI_COPY --name &quot;$NAME Encrypted&quot; --encrypted --source-region $REGION --region $REGION --query &#39;ImageId&#39; --profile $PROFILE` 
AMI_ENC=`sed -e &#39;s/^&quot;//&#39; -e &#39;s/&quot;$//&#39; &lt;&lt;&lt;&quot;$AMI_ENC&quot;`

echo &quot;Waiting for Encrypted AMI $AMI_ENC to be available...&quot;
aws ec2 wait image-available --image-ids $AMI_ENC --profile $PROFILE

echo &quot;Deleting unneeded AMI Copy&quot;
REMOVED=`aws ec2 deregister-image --image-id $AMI_COPY --profile $PROFILE`

aws ec2 wait instance-terminated --instance-ids $INSTANCE --profile $PROFILE
echo &quot;Everything is good! Your new AMI &#39;$NAME Encrypted&#39; is available as $AMI_ENC&quot;</pre
            >
          </noscript>
          <script src="https://gist.github.com/PartTimeLegend/afeb172468753143bf9846968af3afed.js"></script>
        </article>
      </div>
    </main>
  </body>
</html>
